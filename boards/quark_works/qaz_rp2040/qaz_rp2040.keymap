/*
 * Copyright (c) 2024 The ZMK Contributors
 *
 * SPDX-License-Identifier: MIT
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/rgb.h>

/ {
    combos {
        compatible = "zmk,combos";

        combo_boot {
            bindings = <&bootloader>;
            key-positions = <0 9>;
        };

        combo_unlock {
            bindings = <&studio_unlock>;
            key-positions = <0 10>;
        };

        combo_tab_right {
            bindings = <&kp TAB>;
            key-positions = <27 26>;
            layers = <0>;
        };

        combo_ret_right {
            bindings = <&kp RET>;
            key-positions = <27 28 26>;
            layers = <0>;
        };

        combo_ret_left {
            bindings = <&kp RET>;
            key-positions = <21 22 23>;
            layers = <0>;
        };

        combo_tab_left {
            bindings = <&kp TAB>;
            key-positions = <22 23>;
            layers = <0>;
        };
    };

    macros {
        as: as {
            compatible = "zmk,behavior-macro-one-param";
            display-name = "Auto-Shift";
            #binding-cells = <1>;
            bindings =
                <&macro_press>,
                <&macro_param_1to1 &macro_param_1to2 &autoshift_hold_tap MACRO_PLACEHOLDER MACRO_PLACEHOLDER>,
                <&macro_pause_for_release>,
                <&macro_release>,
                <&macro_param_1to1 &macro_param_1to2 &autoshift_hold_tap MACRO_PLACEHOLDER MACRO_PLACEHOLDER>;
        };

        shifted: shifted_key {
            compatible = "zmk,behavior-macro-one-param";
            display-name = "Shifted";
            #binding-cells = <1>;
            bindings =
                <&macro_press>,
                <&kp LSHIFT &macro_param_1to1>,
                <&macro_tap>,
                <&kp MACRO_PLACEHOLDER>,
                <&macro_release>,
                <&kp LSHIFT>;
        };

        lm: lm {
            compatible = "zmk,behavior-macro-two-param";
            display-name = "Layer Mod";
            #binding-cells = <2>;
            bindings =
                <&macro_param_1to1>,
                <&macro_press>,
                <&mo MACRO_PLACEHOLDER &macro_param_2to1 &kp MACRO_PLACEHOLDER>,
                <&macro_pause_for_release>,
                <&macro_param_2to1>,
                <&macro_release>,
                <&kp MACRO_PLACEHOLDER &macro_param_1to1 &mo MACRO_PLACEHOLDER>;
        };

        layer_shifted: layer_shifted {
            compatible = "zmk,behavior-macro-one-param";
            display-name = "Layer + Shift";
            #binding-cells = <1>;
            bindings =
                <&macro_param_1to1>,
                <&macro_press>,
                <&mo MACRO_PLACEHOLDER &kp LSHFT>,
                <&macro_pause_for_release>,
                <&macro_release>,
                <&kp LSHFT &macro_param_1to1 &mo MACRO_PLACEHOLDER>;
        };
    };

    behaviors {
        autoshift_hold_tap: autoshift_hold_tap {
            compatible = "zmk,behavior-hold-tap";
            bindings = <&shifted>, <&kp>;
            #binding-cells = <2>;
            tapping-term-ms = <200>;
            quick-tap-ms = <200>;
            require-prior-idle-ms = <125>;
            flavor = "balanced";
        };

        lmt: lmt {
            compatible = "zmk,behavior-hold-tap";
            display-name = "Left Mod-Tap";
            bindings = <&kp>, <&kp>;
            #binding-cells = <2>;
            tapping-term-ms = <200>;
            quick-tap-ms = <200>;
            require-prior-idle-ms = <125>;
            hold-trigger-key-positions = <36 28 19 9 8 18 6 7 8 16 17 18 25 26 27 28 33 34 35 15 5 32>;
        };

        rmt: rmt {
            compatible = "zmk,behavior-hold-tap";
            display-name = "Right Mod-Tap";
            bindings = <&kp>, <&kp>;
            #binding-cells = <2>;
            tapping-term-ms = <200>;
            quick-tap-ms = <200>;
            require-prior-idle-ms = <125>;
            hold-trigger-key-positions = <0 1 2 3 4 10 11 12 13 14 20 21 22 23 24 29 30 31 32 33>;
        };

        m_dotque: m_dotque {
            compatible = "zmk,behavior-mod-morph";
            display-name = "Dot-Question";
            bindings = <&kp DOT>, <&kp SLASH>;
            #binding-cells = <0>;
            mods = <(MOD_LSFT)>;
            keep-mods = <(MOD_LSFT)>;
        };

        m_comexc: m_comexc {
            compatible = "zmk,behavior-mod-morph";
            display-name = "Comma-Exclamation";
            bindings = <&kp COMMA>, <&kp EXCL>;
            #binding-cells = <0>;
            mods = <(MOD_LSFT)>;
        };

        td_escq: td_escq {
            compatible = "zmk,behavior-tap-dance";
            display-name = "Q/L3, Esc";
            #binding-cells = <0>;
            bindings = <&lt 3 Q>, <&kp ESC>;
        };

        lsft_lt: lsft_lt {
            compatible = "zmk,behavior-hold-tap";
            display-name = "Shifted Layer-Tap";
            #binding-cells = <2>;
            bindings = <&layer_shifted>, <&kp>;
            tapping-term-ms = <200>;
            quick-tap-ms = <150>;
            flavor = "tap-unless-interrupted";
        };

        mo_tog: mo_tog {
            compatible = "zmk,behavior-hold-tap";
            display-name = "Tap-Toggle Layer";
            #binding-cells = <2>;
            bindings = <&mo>, <&tog>;
            tapping-term-ms = <200>;
            flavor = "balanced";
        };

        td_capsnum: td_capsnum {
            compatible = "zmk,behavior-tap-dance";
            display-name = "Caps/Num/Scroll Lock Tap Dance";
            #binding-cells = <0>;
            bindings = <&kp CAPS>, <&kp KP_NUM>, <&kp SLCK>;
        };

        m_slash: m_slash {
            compatible = "zmk,behavior-mod-morph";
            display-name = "Forward-Back Slash";
            bindings = <&kp SLASH>, <&kp BACKSLASH>;
            #binding-cells = <0>;
            mods = <(MOD_LSFT)>;
        };

        m_1grv: m_1grv {
            compatible = "zmk,behavior-mod-morph";
            display-name = "N1-Grave";
            bindings = <&kp N1>, <&kp GRAVE>;
            #binding-cells = <0>;
            mods = <(MOD_LSFT)>;
        };

        lt_dotq: lt_dotq {
            compatible = "zmk,behavior-hold-tap";
            display-name = "Layer-Tap Dot-Question Mark";
            #binding-cells = <2>;
            bindings = <&lt>, <&m_dotque>;
            tapping-term-ms = <200>;
        };
    };

    keymap {
        compatible = "zmk,keymap";

        default_layer {
            bindings = <
&td_escq     &kp W        &kp E         &kp R         &kp T            &kp Y        &kp U         &kp I         &kp O         &kp P
&lmt LGUI A  &lmt LALT S  &lmt LCTRL D  &lmt LSHFT F  &kp G            &kp H        &rmt RSHFT J  &rmt RCTRL K  &rmt RALT L   &rmt RGUI SQT
&kp Z        &kp X        &kp C         &kp V         &kp B            &kp N        &kp M         &m_comexc     &lt_dotq 2 0
&sk LGUI     &sk LALT     &sk LCTRL                   &lsft_lt 1 BSPC  &lt 1 SPACE                &mo_tog 2 2   &kt RSHFT     &td_capsnum
            >;
        };

        num_sym {
            bindings = <
&m_1grv  &kp N2  &kp N3  &kp N4     &kp N5  &kp N6  &kp N7    &kp N8     &kp N9    &kp N0
&kp TAB  &trans  &trans  &kp MINUS  &trans  &trans  &kp SEMI  &kp EQUAL  &kp LBKT  &kp RBKT
&kp DEL  &trans  &trans  &kp PLUS   &trans  &trans  &m_slash  &kp COMMA  &kp DOT
&trans   &trans  &trans             &trans  &trans            &trans     &trans    &trans
            >;
        };

        nav {
            bindings = <
&trans    &kp PG_UP  &kp UP     &kp PG_DN  &trans   &trans  &trans  &trans  &trans  &trans
&kp HOME  &kp LEFT   &kp DOWN   &kp RIGHT  &kp END  &trans  &trans  &trans  &trans  &trans
&kt LGUI  &kt LALT   &kt LCTRL  &kt LSHFT  &trans   &trans  &trans  &trans  &trans
&trans    &trans     &trans                &trans   &trans          &trans  &trans  &trans
            >;
        };

        layer_3 {
            bindings = <
&trans  &trans  &trans  &trans  &trans  &trans  &trans           &trans           &trans           &trans
&trans  &trans  &trans  &trans  &trans  &trans  &rgb_ug RGB_TOG  &rgb_ug RGB_EFR  &rgb_ug RGB_EFF  &trans
&trans  &trans  &trans  &trans  &trans  &trans  &trans           &trans           &trans
&trans  &trans  &trans          &trans  &trans                   &trans           &trans           &trans
            >;
        };
    };
};
